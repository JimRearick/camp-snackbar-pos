<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Camp Snackbar POS</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="/static/css/pos.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1><img src="/static/images/IF_logo.png" alt="Camp Logo" class="header-logo"> Camp Snackbar</h1>
            <div class="header-nav">
                <!-- Admin-only navigation -->
                <a href="/admin.html" id="adminNavBtn" style="display: none;"><span class="icon">‚öôÔ∏è</span> Admin</a>
                <a href="/reports.html" id="reportsNavBtn" style="display: none;"><span class="icon">üìä</span> Reports</a>
                <button onclick="showPrepQueueModal()" title="View Prep Queue">
                    <span class="icon">üçî</span> Prep Queue <span id="prepQueueCount" style="display: none;"></span>
                </button>
                <button onclick="window.authLogout()"><span class="icon">üö™</span> Logout</button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Column: Products -->
            <div class="products-column">
                <!-- Account Selection Bar -->
                <div class="account-bar">
                    <button class="btn-select-account" id="btnSelectAccount" onclick="showAccountSelector()">
                        Select Account
                    </button>
                    <div id="selectedAccountInfo" class="account-info-compact" style="display: none;">
                        <!-- Account info will be populated here -->
                    </div>
                </div>

                <!-- Products Grid -->
                <div class="products-section">
                    <div id="productsGrid" class="products-grid">
                        <!-- Products loaded dynamically -->
                    </div>
                </div>
            </div>

            <!-- Right Column: Cart -->
            <div class="cart-section">
                <h2>Current Order</h2>
                <div id="cartItems" class="cart-items">
                    <div class="empty-cart">
                        <p>Cart is empty</p>
                        <p class="hint">Tap items to add</p>
                    </div>
                </div>
                <div class="cart-total">
                    <span>Total:</span>
                    <span id="cartTotal" class="total-amount">$0.00</span>
                </div>
                <div class="cart-actions">
                    <button class="btn-clear" onclick="clearCart()">Clear</button>
                    <button class="btn-checkout" onclick="checkout()">Checkout</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Selector Modal -->
    <div id="accountModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Select Account</h2>
                <button class="btn-close" onclick="hideAccountSelector()">‚úï</button>
            </div>
            <div class="modal-body">
                <input type="text" id="accountSearch" class="search-input"
                       placeholder="Search accounts..." oninput="filterAccounts()">
                <div id="accountsList" class="accounts-list">
                    <!-- Accounts loaded dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-add-account" onclick="showNewAccountForm()">+ Add New Account</button>
            </div>
        </div>
    </div>

    <!-- New Account Form Modal -->
    <div id="newAccountModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Account</h2>
                <button class="btn-close" onclick="hideNewAccountForm()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="newAccountForm" class="account-form">
                    <div class="form-group">
                        <label for="accountName">Account Name *</label>
                        <input type="text" id="accountName" class="form-input"
                               placeholder="e.g., Smith Family or John Doe" required>
                    </div>

                    <div class="form-group">
                        <label for="accountType">Account Type *</label>
                        <select id="accountType" class="form-input" required onchange="toggleFamilyMembersField()">
                            <option value="family">Family</option>
                            <option value="individual">Individual</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="notes">Notes (Optional)</label>
                        <textarea id="notes" class="form-input form-textarea"
                                  placeholder="Additional information..." rows="3"></textarea>
                    </div>

                    <div class="form-group" id="familyMembersGroup" style="display: flex;">
                        <label for="familyMembers">Family Members (one per line)</label>
                        <textarea id="familyMembers" class="form-input form-textarea"
                                  placeholder="Enter family member names, one per line" rows="4"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="hideNewAccountForm()">Cancel</button>
                <button class="btn-confirm" onclick="createNewAccount()">Create Account</button>
            </div>
        </div>
    </div>

    <!-- Confirm Clear Modal -->
    <div id="confirmModal" class="modal hidden">
        <div class="modal-content confirm-modal">
            <div class="modal-header">
                <h2>Clear Everything?</h2>
            </div>
            <div class="modal-body">
                <p class="confirm-message">This will clear the cart and deselect the account.</p>
                <p class="confirm-hint">All items will be removed.</p>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="hideConfirmClear()">Cancel</button>
                <button class="btn-confirm" onclick="confirmClear()">Clear All</button>
            </div>
        </div>
    </div>

    <!-- Checkout Confirmation Modal -->
    <div id="checkoutConfirmModal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Confirm Order</h2>
                <button class="btn-close" onclick="hideCheckoutConfirm()">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="checkoutOrderDetails">
                    <!-- Order details populated dynamically -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="hideCheckoutConfirm()">Cancel</button>
                <button class="btn-confirm" onclick="confirmCheckout()">Complete Order</button>
            </div>
        </div>
    </div>

    <!-- Prep Queue Modal -->
    <div id="prepQueueModal" class="modal hidden">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>üçî Prep Queue</h2>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="view-toggle-btn active" id="viewByProductBtn" onclick="setPrepQueueViewMode('product')">By Product</button>
                    <button class="view-toggle-btn" id="viewByOrderBtn" onclick="setPrepQueueViewMode('order')">By Order</button>
                </div>
                <button class="btn-close" onclick="hidePrepQueueModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="prepQueueList" style="max-height: 60vh; overflow-y: auto;">
                    <div style="text-align: center; padding: 2rem; color: #999;">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Message -->
    <div id="successMessage" class="toast hidden">
        <span id="successText">Transaction completed successfully!</span>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="toast toast-error hidden">
        <span id="errorText"></span>
    </div>

    <!-- Socket.IO -->
    <script src="/static/js/socket.io.min.js"></script>

    <!-- Authentication Check -->
    <script type="module">
        import { safeInitAuth, displayUserInfo } from './js/utils/auth.js';

        // Require POS or Admin role
        safeInitAuth(['pos', 'admin'], (user) => {
            console.log('POS authenticated:', user.username, '(', user.role, ')');

            // Show admin navigation if user is admin
            if (user.role === 'admin') {
                document.getElementById('adminNavBtn').style.display = 'flex';
                document.getElementById('reportsNavBtn').style.display = 'flex';
            }
        });
    </script>

    <script type="module" src="/static/js/pos.js"></script>
</body>
</html>
